const archiver = require('archiver');
const { Data, User, Link } = require('../database/models');
const moment = require('moment');
const { createCsvWriter } = require('csv-writer');

class ZipGenerator {
  
  // Generate full data report ZIP
  async generateFullReport() {
    return new Promise(async (resolve, reject) => {
      try {
        // Get all data
        const allData = await Data.find().sort({ timestamp: -1 });
        const allUsers = await User.find({ is_active: true });
        const allLinks = await Link.find({ is_active: true });

        // Create archive
        const archive = archiver('zip', { zlib: { level: 9 } });
        const chunks = [];
        
        archive.on('data', (chunk) => chunks.push(chunk));
        archive.on('end', () => resolve(Buffer.concat(chunks)));
        archive.on('error', reject);

        // Add README file
        const readmeContent = this.generateReadmeContent(allData, allUsers, allLinks);
        archive.append(readmeContent, { name: 'README.txt' });

        // Add statistics file
        const statsContent = this.generateStatsContent(allData, allUsers, allLinks);
        archive.append(statsContent, { name: 'STATISTICS.txt' });

        // Add CSV files
        const usersCsv = await this.generateUsersCsv(allUsers);
        archive.append(usersCsv, { name: 'data_csv/users_data.csv' });

        const dataCsv = await this.generateDataCsv(allData);
        archive.append(dataCsv, { name: 'data_csv/photos_metadata.csv' });

        // Add HTML summary report
        const htmlReport = this.generateHtmlReport(allData, allUsers, allLinks);
        archive.append(htmlReport, { name: 'summary_report.html' });

        // Finalize archive
        archive.finalize();

      } catch (error) {
        reject(error);
      }
    });
  }

  // Generate README content
  generateReadmeContent(allData, allUsers, allLinks) {
    return `ğŸ“Š FULL DATA REPORT\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n` +
           `Generated by: Freelance Bot System\n` +
           `Author: RizzXploit - JCN Community\n` +
           `Timestamp: ${moment().format('DD/MM/YYYY HH:mm:ss')}\n\n` +
           `ğŸ“ FILE STRUCTURE:\n` +
           `â€¢ README.txt - This file\n` +
           `â€¢ STATISTICS.txt - Detailed statistics\n` +
           `â€¢ data_csv/users_data.csv - User information\n` +
           `â€¢ data_csv/photos_metadata.csv - Photo metadata\n` +
           `â€¢ summary_report.html - Visual summary\n\n` +
           `ğŸ” CONFIDENTIAL - For authorized use only\n`;
  }

  // Generate statistics content
  generateStatsContent(allData, allUsers, allLinks) {
    const premiumUsers = allUsers.filter(u => u.role === 'premium').length;
    const memberUsers = allUsers.filter(u => u.role === 'member').length;
    const activeLinks = allLinks.filter(l => l.is_active).length;
    
    const today = moment().startOf('day');
    const dataToday = allData.filter(d => moment(d.timestamp).isAfter(today)).length;
    
    const mostActiveUser = allUsers.reduce((prev, current) => 
      (prev.data_collected > current.data_collected) ? prev : current
    );

    return `ğŸ“Š DATA REPORT PREMIUM\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n` +
           `ğŸ‘¤ USER STATISTICS:\n` +
           `â€¢ Total Users: ${allUsers.length}\n` +
           `â€¢ Premium Users: ${premiumUsers}\n` +
           `â€¢ Member Users: ${memberUsers}\n` +
           `â€¢ Active Today: ${allUsers.filter(u => moment(u.last_active).isAfter(today)).length}\n\n` +
           
           `ğŸ“ˆ DATA COLLECTION:\n` +
           `â€¢ Total Photos: ${allData.length}\n` +
           `â€¢ Photos Today: ${dataToday}\n` +
           `â€¢ Average per User: ${(allData.length / allUsers.length).toFixed(1)}\n` +
           `â€¢ Most Active User: ${mostActiveUser.user_id} (${mostActiveUser.data_collected} photos)\n\n` +
           
           `ğŸ”— LINK PERFORMANCE:\n` +
           `â€¢ Total Links Shared: ${allLinks.reduce((sum, link) => sum + link.click_count, 0)}\n` +
           `â€¢ Active Links: ${activeLinks}\n` +
           `â€¢ Total Data from Links: ${allLinks.reduce((sum, link) => sum + link.data_collected, 0)}\n\n` +
           
           `ğŸŒ GEOGRAPHIC DATA:\n` +
           `â€¢ Indonesia: ${allData.filter(d => d.country === 'Indonesia').length} photos\n` +
           `â€¢ Other Countries: ${allData.filter(d => d.country !== 'Indonesia').length} photos\n\n` +
           
           `ğŸ“… REPORT PERIOD: All time until ${moment().format('DD/MM/YYYY')}\n` +
           `ğŸ•’ GENERATED: ${moment().format('DD/MM/YYYY HH:mm:ss')}\n` +
           `ğŸ¤– BOT BY RizzXploit â€¢ JCN Community\n`;
  }

  // Generate users CSV
  async generateUsersCsv(users) {
    const csvWriter = createCsvWriter({
      path: 'temp', // dummy path
      header: [
        { id: 'user_id', title: 'UserID' },
        { id: 'username', title: 'Username' },
        { id: 'role', title: 'Role' },
        { id: 'join_date', title: 'JoinDate' },
        { id: 'data_collected', title: 'DataCollected' },
        { id: 'links_shared', title: 'LinksShared' },
        { id: 'last_active', title: 'LastActive' },
        { id: 'invited_by', title: 'InvitedBy' }
      ]
    });

    const records = users.map(user => ({
      user_id: user.user_id,
      username: user.username || 'N/A',
      role: user.role,
      join_date: moment(user.join_date).format('YYYY-MM-DD HH:mm:ss'),
      data_collected: user.data_collected,
      links_shared: user.links_shared,
      last_active: moment(user.last_active).format('YYYY-MM-DD HH:mm:ss'),
      invited_by: user.invited_by
    }));

    return await csvWriter.stringifyRecords(records);
  }

  // Generate data CSV
  async generateDataCsv(data) {
    const csvWriter = createCsvWriter({
      path: 'temp',
      header: [
        { id: 'file_id', title: 'FileID' },
        { id: 'user_id', title: 'UserID' },
        { id: 'ip_address', title: 'IPAddress' },
        { id: 'device_type', title: 'DeviceType' },
        { id: 'country', title: 'Country' },
        { id: 'timestamp', title: 'Timestamp' },
        { id: 'user_agent', title: 'UserAgent' }
      ]
    });

    const records = data.map(item => ({
      file_id: item.file_id,
      user_id: item.user_id,
      ip_address: item.ip_address,
      device_type: item.device_type,
      country: item.country,
      timestamp: moment(item.timestamp).format('YYYY-MM-DD HH:mm:ss'),
      user_agent: item.user_agent.substring(0, 100) // truncate long user agents
    }));

    return await csvWriter.stringifyRecords(records);
  }

  // Generate HTML report
  generateHtmlReport(allData, allUsers, allLinks) {
    return `<!DOCTYPE html>
<html>
<head>
    <title>Freelance Bot Report</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { background: #2c3e50; color: white; padding: 20px; border-radius: 5px; }
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #3498db; }
        .premium { border-left-color: #e74c3c; }
        .footer { margin-top: 30px; padding: 15px; background: #ecf0f1; border-radius: 5px; text-align: center; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¤– Freelance Bot Report</h1>
        <p>Generated by RizzXploit â€¢ JCN Community</p>
        <p>Date: ${moment().format('DD/MM/YYYY HH:mm:ss')}</p>
    </div>
    
    <div class="stats">
        <div class="stat-card">
            <h3>ğŸ‘¥ Users</h3>
            <p>Total: ${allUsers.length}</p>
            <p>Premium: ${allUsers.filter(u => u.role === 'premium').length}</p>
        </div>
        <div class="stat-card">
            <h3>ğŸ“Š Data</h3>
            <p>Total Photos: ${allData.length}</p>
            <p>Today: ${allData.filter(d => moment(d.timestamp).isAfter(moment().startOf('day'))).length}</p>
        </div>
        <div class="stat-card premium">
            <h3>ğŸ”— Links</h3>
            <p>Active: ${allLinks.filter(l => l.is_active).length}</p>
            <p>Total Clicks: ${allLinks.reduce((sum, link) => sum + link.click_count, 0)}</p>
        </div>
    </div>
    
    <div class="footer">
        <p>ğŸ” Confidential Report - Authorized Use Only</p>
        <p>ğŸ¤– Bot by RizzXploit â€¢ JCN Community</p>
    </div>
</body>
</html>`;
  }
}

module.exports = new ZipGenerator();